<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Brain Power - Cognitive Test Suite | ËÑ≥ÂäõÊ∏¨ÂÆö</title>
<meta name="description" content="Measure your cognitive abilities with 4 scientific mini-games. Reaction speed, color perception, sequence memory, and number recall. Get your brain score.">
<meta name="keywords" content="brain test, IQ test, cognitive test, memory test, reaction time, color perception, ËÑ≥Âäõ„ÉÜ„Çπ„Éà, IQ„ÉÜ„Çπ„Éà, Ë™çÁü•„ÉÜ„Çπ„Éà">
<meta name="robots" content="index, follow">
<meta property="og:type" content="website">
<meta property="og:title" content="Brain Power - Measure Your Cognitive Abilities">
<meta property="og:description" content="4 cognitive challenges. Get your brain score and world ranking.">
<meta name="twitter:card" content="summary_large_image">
<meta name="theme-color" content="#08081a">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß†</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
--bg:#08081a;--surface:#101028;--card:#161638;--border:#1e1e40;
--text:#e8e8f8;--dim:#55557a;--accent:#7c6cf0;--accent2:#00e5ff;
--green:#00e676;--red:#ff5252;--gold:#ffd740;
--font:'Space Grotesk',system-ui,sans-serif;--mono:'DM Mono',monospace;
}
body{background:var(--bg);font-family:var(--font);color:var(--text);min-height:100vh;min-height:100dvh;overflow-x:hidden;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
.app{max-width:480px;margin:0 auto;padding:12px 16px;min-height:100vh;min-height:100dvh;display:flex;flex-direction:column}
.hdr{display:flex;justify-content:space-between;align-items:center;padding:4px 0 12px}
.logo{font-size:18px;font-weight:700;cursor:pointer}
.logo span{background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hdr-r{display:flex;gap:8px;align-items:center}
.pill{background:var(--surface);border:1px solid var(--border);color:var(--dim);padding:3px 10px;border-radius:6px;cursor:pointer;font-size:11px;font-family:var(--font);transition:.2s}
.pill:hover{color:var(--text);border-color:var(--accent)}
.pill.active{background:var(--accent);color:#fff;border-color:var(--accent)}

/* Screens */
.scr{flex:1;display:flex;flex-direction:column;animation:fi .3s ease}
@keyframes fi{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* HOME */
.home-title{font-size:clamp(22px,6vw,32px);font-weight:700;text-align:center;margin:8px 0 2px}
.home-sub{text-align:center;color:var(--dim);font-size:12px;margin-bottom:16px}
.stats-bar{display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;padding:2px 0;scrollbar-width:none}
.stats-bar::-webkit-scrollbar{display:none}
.sb{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:10px 14px;text-align:center;flex:1;min-width:70px}
.sb-val{font-family:var(--mono);font-size:20px;font-weight:700}
.sb-lbl{font-size:9px;color:var(--dim);margin-top:2px;letter-spacing:.5px;text-transform:uppercase}
.games{display:flex;flex-direction:column;gap:10px;flex:1}
.gc{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px 16px;cursor:pointer;transition:.2s;display:flex;align-items:center;gap:14px}
.gc:hover{border-color:var(--accent);transform:translateY(-1px)}
.gc:active{transform:scale(.98)}
.gc-icon{font-size:28px;width:48px;height:48px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.gc-info{flex:1;min-width:0}
.gc-name{font-weight:600;font-size:14px}
.gc-desc{color:var(--dim);font-size:11px;margin-top:2px;line-height:1.3}
.gc-best{font-family:var(--mono);font-size:10px;color:var(--accent);margin-top:3px}
.gc-score{font-family:var(--mono);font-size:18px;font-weight:700;flex-shrink:0;width:36px;text-align:center}

/* GAME COMMON */
.g-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.g-back{background:none;border:none;color:var(--dim);font-size:20px;cursor:pointer;padding:4px 8px;font-family:var(--font)}
.g-back:hover{color:var(--text)}
.g-badge{font-family:var(--mono);font-size:12px;padding:3px 10px;border-radius:6px}
.g-lvl{color:var(--accent);background:rgba(124,108,240,.1)}
.g-sc{color:var(--dim)}
.g-area{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;text-align:center}
.g-msg{font-size:clamp(16px,4.5vw,22px);font-weight:600;min-height:28px}
.g-sub{color:var(--dim);font-size:12px}
.btn{border:none;padding:12px 32px;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;font-family:var(--font);transition:.15s}
.btn:active{transform:scale(.96)}
.btn-p{background:linear-gradient(135deg,var(--accent),#8b7cf0);color:#fff;box-shadow:0 4px 16px rgba(124,108,240,.25)}
.btn-s{background:var(--surface);border:1px solid var(--border);color:var(--text)}
.btn-p:hover,.btn-s:hover{filter:brightness(1.1)}
.btn-row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
.ad{margin-top:16px;padding:12px;border:1px dashed var(--border);border-radius:8px;color:#222;font-size:10px;text-align:center;letter-spacing:1px}

/* REACTION */
.rx-zone{width:100%;flex:1;min-height:220px;border-radius:16px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:background .15s}
.rx-wait{background:linear-gradient(135deg,#2a0a0a,#1a0505)}
.rx-go{background:linear-gradient(135deg,#003a00,#002200)}
.rx-idle{background:var(--surface);cursor:default}
.rx-circle{width:100px;height:100px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:16px}
.rx-dots{display:flex;gap:6px;margin-bottom:12px}
.rx-dot{width:32px;height:3px;border-radius:2px;background:var(--border);transition:.3s}

/* COLOR */
.c-grid{display:grid;gap:5px;width:100%;max-width:340px;aspect-ratio:1;margin:4px auto}
.c-cell{border-radius:8px;cursor:pointer;transition:transform .12s,opacity .12s,box-shadow .2s}
.c-cell:active{transform:scale(.92)}
.c-cell.c-hit{box-shadow:0 0 0 3px var(--green);transform:scale(1.08)}
.c-cell.c-miss{opacity:.3}
.c-lives{display:flex;gap:4px}
.c-heart{font-size:16px;transition:opacity .3s}
.c-heart.lost{opacity:.2}

/* SIMON */
.si-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:200px;margin:4px auto}
.si-btn{width:100%;aspect-ratio:1;border-radius:14px;border:none;transition:filter .12s,transform .12s;opacity:.35;cursor:default}
.si-btn.lit{opacity:1;filter:brightness(1.8);transform:scale(1.06)}
.si-btn.active{opacity:.6;cursor:pointer}
.si-btn.active:hover{opacity:.75}
.si-btn.flash{opacity:1;filter:brightness(1.5);transform:scale(1.03)}
.s0{background:#ff5252}.s1{background:#448aff}.s2{background:#69f0ae}.s3{background:#ffd740}

/* NUMBER */
.n-display{font-family:var(--mono);font-size:clamp(28px,9vw,52px);font-weight:700;color:var(--accent2);text-shadow:0 0 24px rgba(0,229,255,.25);min-height:60px;display:flex;align-items:center;justify-content:center;letter-spacing:6px}
.n-input-display{font-family:var(--mono);font-size:clamp(22px,7vw,38px);color:var(--text);min-height:48px;letter-spacing:4px}
.numpad{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;width:100%;max-width:260px;margin:4px auto}
.np-btn{background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:20px;font-weight:600;padding:12px;border-radius:10px;cursor:pointer;transition:.12s}
.np-btn:active{background:var(--accent);color:#fff;transform:scale(.95)}
.np-del{color:var(--red);font-size:15px}
.np-go{background:var(--accent);color:#fff;font-size:14px}

/* RESULT */
.res-card{background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:20px;width:100%;max-width:360px}
.res-score{font-size:clamp(44px,13vw,68px);font-weight:700;line-height:1}
.res-label{font-size:12px;color:var(--dim);margin-top:2px}
.res-rank{display:inline-block;padding:5px 14px;border-radius:8px;font-weight:700;font-size:18px;margin:10px 0}
.res-stats{display:flex;gap:8px;justify-content:center;margin:12px 0;flex-wrap:wrap}
.rs{background:rgba(255,255,255,.03);border-radius:8px;padding:8px 12px;text-align:center}
.rs-v{font-family:var(--mono);font-size:16px;font-weight:600}
.rs-l{font-size:9px;color:var(--dim);margin-top:1px}

/* STATS SCREEN */
.stat-section{margin-bottom:20px}
.stat-title{font-size:14px;font-weight:600;margin-bottom:10px;color:var(--dim)}
.ability-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.ability-name{font-size:12px;width:80px;color:var(--dim);flex-shrink:0}
.ability-bar-bg{flex:1;height:8px;background:var(--surface);border-radius:4px;overflow:hidden;position:relative}
.ability-bar{height:100%;border-radius:4px;transition:width .6s ease}
.ability-val{font-family:var(--mono);font-size:13px;font-weight:600;width:32px;text-align:right;flex-shrink:0}
.dev-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px;text-align:center;margin-bottom:12px}
.dev-score{font-family:var(--mono);font-size:clamp(36px,10vw,52px);font-weight:700}
.dev-label{font-size:11px;color:var(--dim);margin-top:2px}
.dev-sub{font-size:12px;color:var(--dim);margin-top:8px}
.rank-card{background:var(--card);border-radius:10px;padding:12px;display:flex;align-items:center;gap:12px;margin-bottom:8px}
.rank-pos{font-family:var(--mono);font-size:18px;font-weight:700;color:var(--gold);width:32px}
.rank-info{flex:1;font-size:12px}
.rank-you{border:1px solid var(--accent);background:rgba(124,108,240,.08)}
</style>
</head>
<body>
<div class="app" id="app"></div>
<script>
(function(){
"use strict";

// ===== DATA =====
var DB = JSON.parse(localStorage.getItem("bp_data")||"{}");
if(!DB.bests) DB.bests={};
if(!DB.abilities) DB.abilities={reaction:0,color:0,simon:0,number:0};
if(!DB.plays) DB.plays=0;
function save(){localStorage.setItem("bp_data",JSON.stringify(DB))}

// ===== STATE =====
var S={
  lang:(navigator.language||"en").startsWith("ja")?"ja":"en",
  scr:"home", // home, stats, reaction, color, simon, number, result
};

// ===== I18N =====
var I={
en:{
  title:"Brain Power",sub:"Cognitive Test Suite",
  stats:"Stats",play:"Play",
  reaction:"Reaction Speed",reactionD:"Tap when the screen turns green. 5 rounds.",
  color:"Color Perception",colorD:"Find the tile with a slightly different color.",
  simon:"Sequence Memory",simonD:"Repeat the light pattern from memory.",
  number:"Number Memory",numberD:"Memorize the number before it disappears.",
  best:"Best",lv:"Lv",score:"Score",lives:"Lives",
  waitGreen:"Wait for green...",clickNow:"TAP!",tooEarly:"Too early! Tap to retry",
  findDiff:"Find the different color",correct:"Correct!",wrong:"Wrong!",
  watchSeq:"Watch carefully",yourTurn:"Your turn!",
  memorize:"Memorize",enterNum:"Enter the number",
  result:"Result",gameOver:"Game Over",roundClear:"‚úì",
  tryAgain:"Retry",share:"Share",menu:"Home",next:"Next",ok:"OK",
  round:"Round",of:"of",
  tapCont:"tap to continue",
  devScore:"Deviation Score",worldRank:"Est. World Rank",brainScore:"Brain Score",
  ability:"Ability Scores",scale:"(1-25 scale, 20-22 = world class)",
  noData:"Play games to see your stats!",
  avgReaction:"Avg Reaction",topPct:"Top",
  shareText:function(g,s,r){return"\u26a1 Brain Power: "+g+" - Score "+s+" ("+r+")\nTest yours: "},
},
ja:{
  title:"ËÑ≥ÂäõÊ∏¨ÂÆö",sub:"Ë™çÁü•„ÉÜ„Çπ„Éà„Çπ„Ç§„Éº„Éà",
  stats:"„Çπ„ÉÜ„Éº„Çø„Çπ",play:"„Éó„É¨„Ç§",
  reaction:"ÂèçÂøúÈÄüÂ∫¶",reactionD:"ÁîªÈù¢„ÅåÁ∑ë„Å´„Å™„Å£„Åü„Çâ„Çø„ÉÉ„Éó„ÄÇ5„É©„Ç¶„É≥„Éâ„ÄÇ",
  color:"Ëâ≤ÂΩ©ÊÑüË¶ö",colorD:"ÂæÆÂ¶ô„Å´ÈÅï„ÅÜËâ≤„ÅÆ„Çø„Ç§„É´„ÇíË¶ã„Å§„Åë„Çà„ÅÜ„ÄÇ",
  simon:"Ë®òÊÜ∂„Ç∑„Éº„Ç±„É≥„Çπ",simonD:"ÂÖâ„Å£„Åü„Éë„Çø„Éº„É≥„ÇíË¶ö„Åà„Å¶ÂÜçÁèæ„ÄÇ",
  number:"Êï∞Â≠óË®òÊÜ∂",numberD:"‰∏ÄÁû¨Ë°®Á§∫„Åï„Çå„ÇãÊï∞Â≠ó„ÇíË®òÊÜ∂„ÄÇ",
  best:"ÊúÄÈ´ò",lv:"Lv",score:"„Çπ„Ç≥„Ç¢",lives:"ÊÆãÊ©ü",
  waitGreen:"Á∑ë„ÇíÂæÖ„Å£„Å¶...",clickNow:"„Çø„ÉÉ„ÉóÔºÅ",tooEarly:"Êó©„Åô„ÅéÔºÅ„Çø„ÉÉ„Éó„Åß„É™„Éà„É©„Ç§",
  findDiff:"ÈÅï„ÅÜËâ≤„ÇíË¶ã„Å§„Åë„Å¶",correct:"Ê≠£Ëß£ÔºÅ",wrong:"‰∏çÊ≠£Ëß£...",
  watchSeq:"„Çà„ÅèË¶ã„Å¶",yourTurn:"ÂÜçÁèæ„Åó„Å¶ÔºÅ",
  memorize:"Ë¶ö„Åà„Å¶",enterNum:"Êï∞Â≠ó„ÇíÂÖ•Âäõ",
  result:"ÁµêÊûú",gameOver:"„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº",roundClear:"‚úì",
  tryAgain:"ÂÜçÊåëÊà¶",share:"„Ç∑„Çß„Ç¢",menu:"„Éõ„Éº„É†",next:"Ê¨°„Å∏",ok:"OK",
  round:"„É©„Ç¶„É≥„Éâ",of:"/",
  tapCont:"„Çø„ÉÉ„Éó„ÅßÊ¨°„Å∏",
  devScore:"ÂÅèÂ∑ÆÂÄ§",worldRank:"Êé®ÂÆö‰∏ñÁïå„É©„É≥„ÇØ",brainScore:"ËÑ≥Âäõ„Çπ„Ç≥„Ç¢",
  ability:"ËÉΩÂäõÂÄ§",scale:"(1-25, 20-22„Åå‰∫∫È°ûÊúÄÈ´ò„É¨„Éô„É´)",
  noData:"„Ç≤„Éº„É†„Çí„Éó„É¨„Ç§„Åó„Å¶„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÁ¢∫Ë™çÔºÅ",
  avgReaction:"Âπ≥ÂùáÂèçÂøú",topPct:"‰∏ä‰Ωç",
  shareText:function(g,s,r){return"\u26a1 ËÑ≥ÂäõÊ∏¨ÂÆö: "+g+" - "+s+"ÁÇπ ("+r+")\nÊåëÊà¶: "},
}};
function t(){return I[S.lang]}

// ===== ABILITY CALC (1-25) =====
function calcAbility(game, score){
  var scales={
    reaction:function(s){
      // s = avg ms, lower is better. 150ms=25, 300ms=10, 500ms=1
      if(!s) return 0;
      var v=Math.round(25-((s-100)/20));
      return Math.max(1,Math.min(25,v));
    },
    color:function(s){
      // s = score points. 0=0, 50=5, 150=12, 300=18, 500+=22
      if(!s) return 0;
      var v=Math.round(1+Math.sqrt(s)*1.2);
      return Math.max(1,Math.min(25,v));
    },
    simon:function(s){
      // s = score points. seq length * 15. len10=150=good
      if(!s) return 0;
      var v=Math.round(1+Math.sqrt(s)*1.1);
      return Math.max(1,Math.min(25,v));
    },
    number:function(s){
      // s = score. digits * 20. 7digits=140=good
      if(!s) return 0;
      var v=Math.round(1+Math.sqrt(s)*1.3);
      return Math.max(1,Math.min(25,v));
    }
  };
  return scales[game]?scales[game](score):0;
}
function overallAbility(){
  var a=DB.abilities;
  var vals=[a.reaction,a.color,a.simon,a.number].filter(function(v){return v>0});
  if(!vals.length) return 0;
  return Math.round(vals.reduce(function(a,b){return a+b},0)/vals.length);
}
function calcDeviation(ability){
  // Map 1-25 to deviation score (mean 50, sd 10 range roughly 25-75)
  return Math.round(30 + ability * 2);
}
function estWorldRank(dev){
  if(dev>=70) return "Top 0.1%";
  if(dev>=65) return "Top 1%";
  if(dev>=60) return "Top 5%";
  if(dev>=55) return "Top 15%";
  if(dev>=50) return "Top 30%";
  if(dev>=45) return "Top 50%";
  if(dev>=40) return "Top 70%";
  return "Top 85%";
}
function abilityColor(v){
  if(v>=22) return "#ff00ff";
  if(v>=18) return var_accent2="#00e5ff";
  if(v>=14) return "#00e676";
  if(v>=10) return "#a3ff00";
  if(v>=6) return "#ffe600";
  return "#ff9500";
}
// fix: inline
function abCol(v){
  if(v>=22)return"#ff00ff";if(v>=18)return"#00e5ff";if(v>=14)return"#00e676";
  if(v>=10)return"#a3ff00";if(v>=6)return"#ffe600";return"#ff9500";
}

function getRank(score,max){
  var pct=Math.max(1,Math.min(99,Math.round((1-score/max)*100)));
  if(pct<=1)return{tier:"S+",pct:1,c:"#ff00ff"};
  if(pct<=5)return{tier:"S",pct:5,c:"#bf00ff"};
  if(pct<=10)return{tier:"A+",pct:10,c:"#7b2dff"};
  if(pct<=20)return{tier:"A",pct:20,c:"#00d4ff"};
  if(pct<=35)return{tier:"B+",pct:35,c:"#00ffa3"};
  if(pct<=50)return{tier:"B",pct:50,c:"#a3ff00"};
  if(pct<=65)return{tier:"C+",pct:65,c:"#ffe600"};
  if(pct<=80)return{tier:"C",pct:80,c:"#ff9500"};
  return{tier:"D",pct:90,c:"#ff5252"};
}

// ===== RENDER ENGINE =====
var $=document.getElementById("app");
function R(){
  var h='<div class="hdr">';
  h+='<div class="logo" onclick="go(\'home\')"><span>\u{1f9e0} '+t().title+'</span></div>';
  h+='<div class="hdr-r">';
  h+='<button class="pill'+(S.scr==="stats"?" active":"")+'" onclick="go(\'stats\')">'+t().stats+'</button>';
  h+='<button class="pill" onclick="tl()">'+(S.lang==="ja"?"EN":"JP")+'</button>';
  h+='</div></div>';

  if(S.scr==="home") h+=rHome();
  else if(S.scr==="stats") h+=rStats();
  else if(S.scr==="reaction") h+=rReaction();
  else if(S.scr==="color") h+=rColor();
  else if(S.scr==="simon") h+=rSimon();
  else if(S.scr==="number") h+=rNumber();
  else if(S.scr==="result") h+=rResult();

  $.innerHTML=h;
  postRender();
}

function postRender(){
  if(S.scr==="number"&&S._nPh==="input"){
    var el=document.getElementById("ni");
    if(el) el.focus();
  }
}

// ===== HOME =====
function rHome(){
  var a=DB.abilities,ov=overallAbility();
  var h='<div class="scr">';

  // Quick stats bar
  h+='<div class="stats-bar">';
  h+='<div class="sb"><div class="sb-val" style="color:'+abCol(ov)+'">'+(ov||"-")+'</div><div class="sb-lbl">'+t().brainScore+'</div></div>';
  var names=["reaction","color","simon","number"];
  var icons=["‚ö°","üé®","üí°","üî¢"];
  for(var i=0;i<4;i++){
    var v=a[names[i]]||0;
    h+='<div class="sb"><div class="sb-val" style="color:'+(v?abCol(v):"var(--dim)")+'">'+(v||"-")+'</div><div class="sb-lbl">'+icons[i]+'</div></div>';
  }
  h+='</div>';

  // Game cards
  h+='<div class="games">';
  var games=[
    {id:"reaction",icon:"‚ö°",bg:"linear-gradient(135deg,#ff525220,#ff940020)"},
    {id:"color",icon:"üé®",bg:"linear-gradient(135deg,#ff6b6b15,#ffd74015)"},
    {id:"simon",icon:"üí°",bg:"linear-gradient(135deg,#7c6cf015,#00e5ff15)"},
    {id:"number",icon:"üî¢",bg:"linear-gradient(135deg,#00e67615,#69db7c15)"},
  ];
  for(var i=0;i<games.length;i++){
    var g=games[i],ab=a[g.id]||0;
    h+='<div class="gc" onclick="startG(\''+g.id+'\')">';
    h+='<div class="gc-icon" style="background:'+g.bg+'">'+g.icon+'</div>';
    h+='<div class="gc-info"><div class="gc-name">'+t()[g.id]+'</div>';
    h+='<div class="gc-desc">'+t()[g.id+"D"]+'</div>';
    if(DB.bests[g.id]) h+='<div class="gc-best">'+t().best+': '+DB.bests[g.id]+'</div>';
    h+='</div>';
    h+='<div class="gc-score" style="color:'+abCol(ab)+'">'+(ab||"-")+'</div>';
    h+='</div>';
  }
  h+='</div>';
  h+='<div class="ad"></div>';
  h+='<div style="text-align:center;padding:16px 0 8px;font-size:11px"><a href="about.html" style="color:#55557a;margin:0 10px;text-decoration:none">About</a><a href="privacy.html" style="color:#55557a;margin:0 10px;text-decoration:none">Privacy</a></div>';
  h+='</div>';
  return h;
}

// ===== STATS =====
function rStats(){
  var a=DB.abilities,ov=overallAbility();
  var h='<div class="scr">';

  if(!ov){
    h+='<div class="g-area"><div class="g-msg">'+t().noData+'</div>';
    h+='<button class="btn btn-p" onclick="go(\'home\')">'+t().play+'</button></div></div>';
    return h;
  }

  // Deviation score
  var dev=calcDeviation(ov);
  var wr=estWorldRank(dev);
  h+='<div class="dev-card">';
  h+='<div class="dev-label">'+t().devScore+'</div>';
  h+='<div class="dev-score" style="color:'+abCol(ov)+'">'+dev+'</div>';
  h+='<div class="dev-sub">'+t().worldRank+': <strong>'+wr+'</strong></div>';
  h+='</div>';

  // Ability bars
  h+='<div class="stat-section">';
  h+='<div class="stat-title">'+t().ability+' '+t().scale+'</div>';
  var names=[{k:"reaction",l:t().reaction},{k:"color",l:t().color},{k:"simon",l:t().simon},{k:"number",l:t().number}];
  for(var i=0;i<names.length;i++){
    var n=names[i],v=a[n.k]||0;
    var pct=Math.round(v/25*100);
    h+='<div class="ability-row">';
    h+='<div class="ability-name">'+n.l+'</div>';
    h+='<div class="ability-bar-bg"><div class="ability-bar" style="width:'+pct+'%;background:'+abCol(v)+'"></div></div>';
    h+='<div class="ability-val" style="color:'+abCol(v)+'">'+v+'</div>';
    h+='</div>';
  }
  h+='</div>';

  // Personal bests
  h+='<div class="stat-section">';
  h+='<div class="stat-title">'+t().best+' Scores</div>';
  var bk=DB.bests;
  for(var i=0;i<names.length;i++){
    var n=names[i],b=bk[n.k];
    if(b){
      h+='<div class="rank-card"><div class="rank-pos">'+(n.k==="reaction"?"‚ö°":n.k==="color"?"üé®":n.k==="simon"?"üí°":"üî¢")+'</div>';
      h+='<div class="rank-info">'+n.l+'<br><strong>'+b+'</strong></div></div>';
    }
  }
  h+='</div>';
  h+='<div class="ad"></div>';
  h+='</div>';
  return h;
}

// ===== REACTION GAME =====
var RX={phase:"idle",round:0,results:[],cur:null,tid:null,canProc:false};
function rxInit(){RX={phase:"idle",round:0,results:[],cur:null,tid:null,canProc:false}}
function rxStart(){RX.round=0;RX.results=[];rxNext()}
function rxNext(){
  if(RX.round>=5){S._rxDone=true;R();return}
  RX.phase="wait";RX.cur=null;RX.canProc=false;R();
  var d=1500+Math.random()*3500;
  RX.tid=setTimeout(function(){RX.phase="go";RX._t0=performance.now();R()},d);
}
function rReaction(){
  var tx=t(),p=RX.phase;
  var h='<div class="scr">';
  h+='<div class="g-hdr"><button class="g-back" onclick="go(\'home\')">‚Üê</button>';
  if(p!=="idle")h+='<span class="g-badge g-lvl">'+tx.round+' '+(RX.round+(p==="result"||S._rxDone?0:1))+' '+tx.of+' 5</span>';
  h+='<span class="g-badge g-sc">‚ö°</span></div>';

  // Round dots
  if(p!=="idle"){
    h+='<div class="rx-dots">';
    for(var i=0;i<5;i++){
      var c=i<RX.round?"var(--green)":i===RX.round&&p!=="result"&&!S._rxDone?(p==="wait"?"var(--red)":p==="go"?"var(--green)":"var(--border)"):"var(--border)";
      h+='<div class="rx-dot" style="background:'+c+'"></div>';
    }
    h+='</div>';
  }

  if(p==="idle"){
    h+='<div class="g-area">';
    h+='<div class="rx-circle" style="background:radial-gradient(circle,rgba(124,108,240,.15),transparent);border:2px solid rgba(124,108,240,.2)"><span style="font-size:40px">‚ö°</span></div>';
    h+='<div class="g-sub">'+tx.reactionD+'</div>';
    h+='<button class="btn btn-p" onclick="rxStart()">'+tx.play+'</button>';
    h+='</div>';
  } else if(p==="wait"){
    h+='<div class="rx-zone rx-wait" onclick="rxTap()">';
    h+='<div class="rx-circle" style="background:radial-gradient(circle,rgba(204,34,0,.3),transparent);border:2px solid rgba(204,34,0,.4)"><div style="width:50px;height:50px;border-radius:50%;background:#cc2200;box-shadow:0 0 30px rgba(204,34,0,.5)"></div></div>';
    h+='<div class="g-msg" style="color:#cc4444">'+tx.waitGreen+'</div>';
    h+='</div>';
  } else if(p==="go"){
    h+='<div class="rx-zone rx-go" onclick="rxTap()">';
    h+='<div class="rx-circle" style="background:radial-gradient(circle,rgba(0,255,102,.4),transparent);border:2px solid rgba(0,255,102,.5)"><div style="width:50px;height:50px;border-radius:50%;background:#00ff66;box-shadow:0 0 40px rgba(0,255,102,.7)"></div></div>';
    h+='<div class="g-msg" style="color:#00ff66;font-size:clamp(24px,7vw,36px)">'+tx.clickNow+'</div>';
    h+='</div>';
  } else if(p==="early"){
    h+='<div class="rx-zone rx-wait" onclick="rxTap()">';
    h+='<span style="font-size:48px">üò¨</span>';
    h+='<div class="g-msg" style="color:var(--red)">'+tx.tooEarly+'</div>';
    h+='</div>';
  } else if(p==="result"){
    var rr=getRank(RX.cur,500);
    h+='<div class="rx-zone rx-idle" onclick="rxTapRes()">';
    h+='<div style="font-size:clamp(40px,12vw,64px);font-weight:800;color:'+rr.c+';font-family:var(--mono)">'+RX.cur+'<span style="font-size:.35em;opacity:.6">ms</span></div>';
    h+='<div class="g-sub">'+tx.tapCont+'</div>';
    h+='</div>';
  }

  // Done
  if(S._rxDone){
    var avg=Math.round(RX.results.reduce(function(a,b){return a+b},0)/RX.results.length);
    var best=Math.min.apply(null,RX.results);
    var rk=getRank(avg,500);
    h+='<div class="g-area">';
    h+='<div style="font-size:clamp(44px,13vw,68px);font-weight:800;color:'+rk.c+';font-family:var(--mono)">'+avg+'<span style="font-size:.3em;opacity:.6">ms</span></div>';
    h+='<div class="res-rank" style="background:'+rk.c+'20;color:'+rk.c+'">'+rk.tier+' <span style="font-size:.7em;opacity:.7">'+t().topPct+' '+rk.pct+'%</span></div>';
    h+='<div class="res-stats">';
    for(var i=0;i<RX.results.length;i++){
      var ib=RX.results[i]===best;
      h+='<div class="rs" style="'+(ib?"border:1px solid "+rk.c+"50;color:"+rk.c:"")+'"><div class="rs-v">'+RX.results[i]+'</div><div class="rs-l">R'+(i+1)+'</div></div>';
    }
    h+='</div>';
    h+='<div class="btn-row"><button class="btn btn-s" onclick="rxSave('+avg+');go(\'home\')">'+tx.menu+'</button>';
    h+='<button class="btn btn-p" onclick="rxSave('+avg+');rxInit();rxStart()">'+tx.tryAgain+'</button></div>';
    h+='</div>';
  }
  h+='</div>';
  return h;
}
window.rxStart=rxStart;
window.rxInit=rxInit;
window.rxTap=function(){
  if(RX.phase==="wait"){clearTimeout(RX.tid);RX.phase="early";R()}
  else if(RX.phase==="early"){rxNext()}
  else if(RX.phase==="go"){
    RX.cur=Math.round(performance.now()-RX._t0);
    RX.results.push(RX.cur);RX.round++;
    if(RX.round>=5){S._rxDone=true;R()}
    else{RX.phase="result";RX.canProc=false;R();setTimeout(function(){RX.canProc=true},600)}
  }
};
window.rxTapRes=function(){if(RX.phase==="result"&&RX.canProc)rxNext()};
window.rxSave=function(avg){
  if(!DB.bests.reaction||avg<DB.bests.reaction) DB.bests.reaction=avg;
  DB.abilities.reaction=calcAbility("reaction",avg);save();
};

// ===== COLOR GAME =====
var CG={lv:1,sc:0,lives:3,grid:[],target:-1,sz:0,fb:null,diff:0};
function cgInit(){CG={lv:1,sc:0,lives:3,grid:[],target:-1,sz:0,fb:null,diff:0};cgRound()}
function cgRound(){
  // FIXED: Gradual difficulty curve
  // Level 1: diff=50 (very obvious), increases slowly
  // diff decreases by 1.5 per level, minimum 4
  var sz=Math.min(2+Math.floor(CG.lv/4),7);
  var total=sz*sz;
  CG.diff=Math.max(4, Math.round(50 - (CG.lv-1)*1.5));
  var hue=Math.floor(Math.random()*360);
  var sat=45+Math.floor(Math.random()*25);
  var lig=35+Math.floor(Math.random()*25);
  CG.target=Math.floor(Math.random()*total);
  CG.grid=[];
  for(var i=0;i<total;i++){
    if(i===CG.target){
      // Vary which dimension changes for extra challenge at high levels
      var dH=0,dS=0,dL=0;
      if(CG.lv<10){
        // Early: hue shift only (most noticeable)
        dH=(Math.random()>.5?1:-1)*CG.diff;
      } else if(CG.lv<20){
        // Mid: mix hue and lightness
        dH=(Math.random()>.5?1:-1)*Math.round(CG.diff*0.7);
        dL=(Math.random()>.5?1:-1)*Math.round(CG.diff*0.3);
      } else {
        // Hard: lightness only (hardest to see)
        dL=(Math.random()>.5?1:-1)*Math.round(CG.diff*0.8);
        dS=(Math.random()>.5?1:-1)*Math.round(CG.diff*0.3);
      }
      CG.grid.push({h:(hue+dH+360)%360,s:Math.max(20,Math.min(90,sat+dS)),l:Math.max(15,Math.min(75,lig+dL)),d:true});
    } else {
      CG.grid.push({h:hue,s:sat,l:lig,d:false});
    }
  }
  CG.sz=sz;CG.fb=null;
}
function rColor(){
  var tx=t();
  var h='<div class="scr">';
  h+='<div class="g-hdr"><button class="g-back" onclick="go(\'home\')">‚Üê</button>';
  h+='<span class="g-badge g-lvl">'+tx.lv+' '+CG.lv+'</span>';
  h+='<div class="c-lives">';
  for(var i=0;i<3;i++) h+='<span class="c-heart'+(i>=CG.lives?" lost":"")+'">‚ù§Ô∏è</span>';
  h+='</div></div>';

  if(CG.fb){
    h+='<div class="g-msg" style="color:'+(CG.fb==="ok"?"var(--green)":"var(--red)")+'">'+(CG.fb==="ok"?tx.correct:tx.wrong)+'</div>';
  } else {
    h+='<div class="g-msg">'+tx.findDiff+'</div>';
  }
  h+='<div class="g-sub">'+tx.score+': '+CG.sc+'</div>';

  h+='<div class="c-grid" style="grid-template-columns:repeat('+CG.sz+',1fr)">';
  for(var i=0;i<CG.grid.length;i++){
    var c=CG.grid[i];
    var cls=CG.fb?(c.d?"c-hit":(CG.fb==="ng"?"c-miss":"")):"";
    h+='<div class="c-cell '+cls+'" style="background:hsl('+c.h+','+c.s+'%,'+c.l+'%)" '+(!CG.fb?'onclick="cgTap('+i+')"':'')+'></div>';
  }
  h+='</div>';

  if(CG.fb){
    if(CG.lives<=0){
      h+='<div class="g-msg" style="margin-top:8px">'+tx.gameOver+'</div>';
      h+='<div class="btn-row" style="margin-top:8px"><button class="btn btn-p" onclick="cgDone()">'+tx.result+'</button></div>';
    } else {
      h+='<button class="btn btn-p" style="margin-top:8px" onclick="cgNext()">'+tx.next+'</button>';
    }
  }
  h+='</div>';
  return h;
}
window.cgTap=function(i){
  if(CG.fb)return;
  if(CG.grid[i].d){CG.fb="ok";CG.sc+=CG.lv*10;CG.lv++}
  else{CG.fb="ng";CG.lives--}
  R();
};
window.cgNext=function(){cgRound();R()};
window.cgDone=function(){
  if(!DB.bests.color||CG.sc>DB.bests.color) DB.bests.color=CG.sc;
  DB.abilities.color=calcAbility("color",CG.sc);save();
  S._rGame="color";S._rScore=CG.sc;S._rLv=CG.lv-1;S._rMax=500;S.scr="result";R();
};

// ===== SIMON GAME =====
var SI={seq:[],inp:[],sc:0,phase:"idle",lit:-1,fb:null,showIdx:-1};
function siInit(){SI={seq:[],inp:[],sc:0,phase:"idle",lit:-1,fb:null,showIdx:-1};siAdd()}
function siAdd(){
  SI.seq.push(Math.floor(Math.random()*4));
  SI.inp=[];SI.phase="show";SI.lit=-1;SI.fb=null;SI.showIdx=-1;
  R();
  setTimeout(function(){siShowStep()},500);
}
function siShowStep(){
  SI.showIdx++;
  if(SI.showIdx>=SI.seq.length){SI.phase="input";SI.lit=-1;R();return}
  SI.lit=SI.seq[SI.showIdx];R();
  var spd=Math.max(280,550-SI.seq.length*20);
  setTimeout(function(){SI.lit=-1;R();setTimeout(siShowStep,120)},spd);
}
function rSimon(){
  var tx=t();
  var h='<div class="scr">';
  h+='<div class="g-hdr"><button class="g-back" onclick="go(\'home\')">‚Üê</button>';
  h+='<span class="g-badge g-lvl">'+tx.lv+' '+SI.seq.length+'</span>';
  h+='<span class="g-badge g-sc">'+tx.score+': '+SI.sc+'</span></div>';

  if(SI.fb==="ok") h+='<div class="g-msg" style="color:var(--green)">'+tx.roundClear+'</div>';
  else if(SI.fb==="ng") h+='<div class="g-msg" style="color:var(--red)">'+tx.gameOver+'</div>';
  else if(SI.phase==="show") h+='<div class="g-msg">'+tx.watchSeq+'</div>';
  else if(SI.phase==="input"){h+='<div class="g-msg">'+tx.yourTurn+'</div>';h+='<div class="g-sub">'+SI.inp.length+' / '+SI.seq.length+'</div>'}

  h+='<div class="g-area">';
  h+='<div class="si-grid">';
  for(var i=0;i<4;i++){
    var cls="si-btn s"+i;
    if(SI.lit===i) cls+=" lit";
    else if(SI.phase==="input"&&!SI.fb) cls+=" active";
    h+='<div class="'+cls+'" '+(SI.phase==="input"&&!SI.fb?'onclick="siTap('+i+')"':'')+'></div>';
  }
  h+='</div>';

  if(SI.fb==="ng"){
    h+='<div class="btn-row" style="margin-top:12px"><button class="btn btn-p" onclick="siDone()">'+tx.result+'</button></div>';
  }
  h+='</div></div>';
  return h;
}
window.siTap=function(i){
  if(SI.phase!=="input"||SI.fb)return;
  SI.inp.push(i);
  // Flash without full re-render to avoid flicker
  var btns=document.querySelectorAll(".si-btn");
  if(btns[i]){btns[i].classList.add("flash");setTimeout(function(){btns[i].classList.remove("flash")},150)}
  var idx=SI.inp.length-1;
  if(SI.inp[idx]!==SI.seq[idx]){SI.fb="ng";R();return}
  if(SI.inp.length===SI.seq.length){
    SI.sc+=SI.seq.length*15;SI.fb="ok";R();
    setTimeout(function(){SI.fb=null;siAdd()},600);
  }
};
window.siDone=function(){
  if(!DB.bests.simon||SI.sc>DB.bests.simon) DB.bests.simon=SI.sc;
  DB.abilities.simon=calcAbility("simon",SI.sc);save();
  S._rGame="simon";S._rScore=SI.sc;S._rLv=SI.seq.length-1;S._rMax=500;S.scr="result";R();
};

// ===== NUMBER GAME =====
var NU={digits:"",input:"",len:3,ph:"show",sc:0,fb:null,tid:null};
function nuInit(){NU={digits:"",input:"",len:3,ph:"show",sc:0,fb:null,tid:null};nuRound()}
function nuRound(){
  NU.input="";NU.fb=null;
  var d="";for(var i=0;i<NU.len;i++) d+=Math.floor(Math.random()*10);
  NU.digits=d;NU.ph="show";R();
  var showT=Math.max(900,1200+(NU.len-3)*350);
  clearTimeout(NU.tid);
  NU.tid=setTimeout(function(){NU.ph="input";S._nPh="input";R()},showT);
}
function rNumber(){
  var tx=t();
  var h='<div class="scr">';
  h+='<div class="g-hdr"><button class="g-back" onclick="go(\'home\')">‚Üê</button>';
  h+='<span class="g-badge g-lvl">'+NU.len+' '+(S.lang==="ja"?"Ê°Å":"digits")+'</span>';
  h+='<span class="g-badge g-sc">'+tx.score+': '+NU.sc+'</span></div>';

  h+='<div class="g-area">';
  if(NU.ph==="show"){
    h+='<div class="g-msg">'+tx.memorize+'</div>';
    h+='<div class="n-display">'+NU.digits+'</div>';
  } else {
    if(NU.fb==="ok") h+='<div class="g-msg" style="color:var(--green)">'+tx.roundClear+'</div>';
    else if(NU.fb==="ng"){h+='<div class="g-msg" style="color:var(--red)">'+tx.gameOver+'</div>';h+='<div class="g-sub" style="font-family:var(--mono)">'+NU.digits+' ‚Üí '+NU.input+'</div>'}
    else h+='<div class="g-msg">'+tx.enterNum+'</div>';

    h+='<div class="n-input-display" id="nid">'+(NU.input||'_')+'</div>';

    if(!NU.fb){
      h+='<div class="numpad">';
      for(var n=1;n<=9;n++) h+='<button class="np-btn" onclick="nuIn(\''+n+'\')">'+n+'</button>';
      h+='<button class="np-btn np-del" onclick="nuIn(\'del\')">‚å´</button>';
      h+='<button class="np-btn" onclick="nuIn(\'0\')">0</button>';
      h+='<button class="np-btn np-go" onclick="nuSub()">'+tx.ok+'</button>';
      h+='</div>';
    } else if(NU.fb==="ok"){
      h+='<button class="btn btn-p" style="margin-top:8px" onclick="nuNext()">'+tx.next+'</button>';
    } else {
      h+='<div class="btn-row" style="margin-top:8px"><button class="btn btn-p" onclick="nuDone()">'+tx.result+'</button></div>';
    }
  }
  h+='</div></div>';
  return h;
}
window.nuIn=function(v){
  if(NU.fb)return;
  if(v==="del"){NU.input=NU.input.slice(0,-1)}
  else if(NU.input.length<NU.len+2){NU.input+=v}
  // Update display without full re-render to prevent flicker
  var el=document.getElementById("nid");
  if(el){el.textContent=NU.input||"_"}
  else R();
};
window.nuSub=function(){
  if(!NU.input||NU.fb)return;
  if(NU.input===NU.digits){NU.fb="ok";NU.sc+=NU.len*20;NU.len++}
  else{NU.fb="ng"}
  R();
};
window.nuNext=function(){NU.fb=null;nuRound()};
window.nuDone=function(){
  clearTimeout(NU.tid);
  if(!DB.bests.number||NU.sc>DB.bests.number) DB.bests.number=NU.sc;
  DB.abilities.number=calcAbility("number",NU.sc);save();
  S._rGame="number";S._rScore=NU.sc;S._rLv=NU.len-1;S._rMax=400;S.scr="result";R();
};

// Keyboard for number
document.addEventListener("keydown",function(e){
  if(S.scr!=="number"||NU.ph!=="input"||NU.fb)return;
  if(e.key>="0"&&e.key<="9") nuIn(e.key);
  else if(e.key==="Backspace") nuIn("del");
  else if(e.key==="Enter") nuSub();
});

// ===== RESULT =====
function rResult(){
  var tx=t(),g=S._rGame,sc=S._rScore,lv=S._rLv,mx=S._rMax;
  var rk=getRank(sc,mx);
  var ab=DB.abilities[g]||0;
  var gName=tx[g];

  var h='<div class="scr">';
  h+='<div class="g-area">';
  h+='<div class="res-card">';
  h+='<div style="font-size:13px;color:var(--dim);margin-bottom:6px">'+gName+'</div>';
  h+='<div class="res-score" style="color:'+rk.c+'">'+sc+'</div>';
  h+='<div class="res-label">'+tx.score+'</div>';
  h+='<div class="res-rank" style="background:'+rk.c+'20;color:'+rk.c+'">'+rk.tier+'</div>';
  h+='<div style="font-size:12px;color:var(--dim)">'+tx.topPct+' '+rk.pct+'%</div>';

  h+='<div class="res-stats">';
  h+='<div class="rs"><div class="rs-v">'+lv+'</div><div class="rs-l">'+tx.lv+'</div></div>';
  h+='<div class="rs"><div class="rs-v" style="color:'+abCol(ab)+'">'+ab+'</div><div class="rs-l">Ability</div></div>';
  if(DB.bests[g]) h+='<div class="rs"><div class="rs-v">'+DB.bests[g]+'</div><div class="rs-l">'+tx.best+'</div></div>';
  h+='</div>';

  h+='<div class="btn-row">';
  h+='<button class="btn btn-s" onclick="go(\'home\')">'+tx.menu+'</button>';
  h+='<button class="btn btn-p" onclick="startG(\''+g+'\')">'+tx.tryAgain+'</button>';
  h+='</div>';
  h+='</div>';
  h+='<div class="ad"></div>';
  h+='</div></div>';
  return h;
}

// ===== NAV =====
window.go=function(scr){
  clearTimeout(NU.tid);clearTimeout(RX.tid);
  S.scr=scr;S._rxDone=false;S._nPh=null;R();
};
window.startG=function(id){
  S.scr=id;S._rxDone=false;S._nPh=null;
  if(id==="reaction"){rxInit()}
  else if(id==="color"){cgInit()}
  else if(id==="simon"){siInit()}
  else if(id==="number"){nuInit()}
  R();
};
window.tl=function(){S.lang=S.lang==="ja"?"en":"ja";document.documentElement.lang=S.lang;R()};

// Touch handling for reaction game
document.addEventListener("touchend",function(e){
  if(S.scr==="reaction"&&(RX.phase==="wait"||RX.phase==="go"||RX.phase==="early")){e.preventDefault();rxTap()}
  else if(S.scr==="reaction"&&RX.phase==="result"){e.preventDefault();rxTapRes()}
},{passive:false});

R();
})();
</script>
</body>
</html>
